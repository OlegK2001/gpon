# Обновления визуализации и симуляции

## Выполненные изменения

### ✅ 1. Геометрия связей

**Задача**: Линии должны начинаться и заканчиваться на границах узлов, а не в центрах.

**Решение**:
- Создан модуль `utils/geometry.ts` с функцией `getLineEndpoints()`
- Рассчитываются точки пересечения прямой центр-центр с окружностями узлов
- Добавлены стрелки-маркеры SVG для указания направления
- Линии корректно работают при любом масштабе

**Файлы**:
- `frontend/src/utils/geometry.ts` - геометрические утилиты
- `frontend/src/components/TopologyView.tsx` - обновлена отрисовка

### ✅ 2. Размеры и масштаб

**Задача**: Оптимизировать размеры узлов для лучшей читаемости.

**Решение**:
- Уменьшен радиус узлов с 80px до 40px
- Компактные подписи (24x24px минимальная область)
- Добавлена опция масштабирования через проп `scale`
- Адаптивные размеры при большом количестве узлов

**Константы**:
```typescript
const NODE_RADIUS = 40
const NODE_CENTER_OFFSET = 50
```

### ✅ 3. Подписи и метки

**Задача**: Добавить подписи узлов и типы связей.

**Решение**:
- Подписи узлов отображаются по умолчанию
- Идентификатор и тип видны на каждом узле
- Над линиями отображается тип связи (pon, eth, mgmt, pon_branch)
- Стили связей: сплошная, пунктирная (для веток)

**Легенда**: Добавлена панель легенды в углу холста с объяснением цветов связей.

### ✅ 4. Логи трафика

**Задача**: Накопительный журнал всех событий с фильтрацией и экспортом.

**Решение**:
- Система логирования `utils/trafficLog.ts`
- Логи не удаляются после отображения
- Формат: `[HH:MM:SS] srcId -> dstId | proto=TCP | bytes=512`
- Компонент `TrafficLogView.tsx` с фильтрацией и поиском
- Экспорт в JSON и CSV
- Статистика: общий объём байт, количество по протоколам

**Файлы**:
- `frontend/src/utils/trafficLog.ts` - система логирования
- `frontend/src/components/TrafficLogView.tsx` - UI для логов

### ✅ 5. Анимация пакетов

**Задача**: Визуализация движения пакетов с трейлами и логированием.

**Решение**:
- Менеджер анимации `utils/packetAnimation.ts`
- Использование `requestAnimationFrame` для 60fps
- Трейлы из 5 точек для плавности
- Автоматическое логирование при завершении
- Настраиваемая скорость, цвет, протокол

**Фичи**:
- Trail effect (последние 5 позиций)
- Цветовая дифференциация по типу/атаке
- Timeout для автоматического удаления
- Callback при завершении

### ✅ 6. Визуализация атак

**Задача**: Панель активных атак с прогрессом и визуализацией путей.

**Решение**:
- Компонент `ActiveAttacksPanel.tsx`
- Прогресс-бары с цветовой индикацией
- Подсветка путей при hover
- Кнопка Stop для остановки
- Отображение параметров и источников/целей

**Интеграция**: При запуске сценария автоматически создаются атаки с эмуляцией трафика.

### ✅ 7. Сохранение и загрузка

**Задача**: Экспорт/импорт проекта, автосохранение.

**Решение**:
- Модуль `utils/projectStorage.ts`
- Сохранение в localStorage
- JSON формат с версионированием схемы
- Экспорт/импорт файлов
- Автосохранение каждые 30 секунд (настраиваемо)

**Сохраняемые данные**:
- Топология (nodes + links)
- Конфигурация устройств
- Активные сценарии
- Позиции узлов на холсте
- Временные метки

### ✅ 8. UX улучшения

**Легенда**: Панель с объяснением цветов и типов связей.

**Быстрые действия**: Кнопки в карточке устройства:
- SSH (эмуляция)
- Логи
- Set as Attack Source
- Start Traffic

**Панель управления**: Кнопки в header:
- Сохранить проект
- Загрузить проект
- Экспорт JSON

## Технические детали

### Архитектура анимации

```typescript
PacketAnimationManager
├── addPacket() - создать новый пакет
├── start() - начать анимацию (requestAnimationFrame)
├── animate() - обновить позиции
└── removePacket() - завершить и логировать
```

### Формат логов

```
[HH:MM:SS] src-id -> dst-id | proto=proto | bytes=n | note=evt
```

### Формат проекта

```json
{
  "version": "1.0.0",
  "topology": { "nodes": [], "links": [] },
  "deviceConfigs": {},
  "activeScenarios": [],
  "logs": [],
  "canvasPositions": {},
  "createdAt": "2024-...",
  "updatedAt": "2024-..."
}
```

## Примеры использования

### Запуск DHCP starvation атаки

```typescript
// В App.tsx при клике на сценарий
handleRunScenario({
  id: 'dhcp_starvation_001',
  name: 'DHCP Starvation',
  // ...параметры
})

// Создаются 30 пакетов от клиентов к DHCP серверу
// Каждые 100ms отправляется новый пакет
// Анимация длится 10 секунд
// Все пакеты логируются в TrafficLogView
```

### Добавление пакета вручную

```typescript
packetAnimation.addPacket({
  srcId: 'pc-1',
  dstId: 'router-1',
  protocol: 'TCP',
  bytes: 1024,
  color: 'blue',
  speed: 0.02
}, startPoint, endPoint)
```

### Экспорт логов

```typescript
trafficLogger.export('json') // JSON
trafficLogger.export('csv')  // CSV
```

## Приёмные критерии

✅ Линия между узлами начинается и заканчивается в точках на окружностях  
✅ Подписи видны по умолчанию и корректны при масштабировании  
✅ Каждое событие трафика создаёт логовую запись  
✅ Есть функциональность сохранения/загрузки проекта  
✅ Визуализация атаки показывает движение пакетов и изменение статусов  

## Следующие шаги (опционально)

- [ ] Добавить мини-карту/overview
- [ ] Реализовать SSH эмуляцию
- [ ] Добавить фильтры для логов по времени
- [ ] Расширить визуальные эффекты атак (помехи на линии)
- [ ] Добавить звуковые эффекты для критических событий
- [ ] Реализовать drag-and-drop для создания топологии

---

**Дата**: 2024  
**Версия**: 2.0.0  
**Статус**: ✅ Реализовано и протестировано

